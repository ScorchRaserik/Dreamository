<!doctype html> 
<html lang="en">
<head> 
	<meta charset="UTF-8" />
    <title>Phaser - Making your first game, part 9</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>
<script type="text/javascript">

	var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

	function preload() {
		game.load.image('sky', 'assets/background.png');
    	game.load.image('ground', 'assets/ground.png');
    	game.load.image('player', 'assets/player.png');
    	game.load.image('shot', 'assets/shot.png');
	}

	//globals
	var platforms;
	var canJump = true;
	var nextFire = 0;
	var fireRate = 100;
	var PLAYER_SCALE = 1.0;

	function create(){

		//Add objects
		game.add.sprite(0, 0, 'sky');
		platforms = game.add.group();
		
		//Physics setup
		game.physics.startSystem(Phaser.Physics.ARCADE);
		platforms.enableBody = true;

		//Build world
		var ground = platforms.create(0, game.world.height - 50, 'ground');
		var ledge1 = platforms.create(0, 400, 'ground');
		var ledge2 = platforms.create(450, 250, 'ground');
		ground.scale.setTo(4, 2);
		ground.body.immovable = true;
    	ledge1.body.immovable = true;
    	ledge2.body.immovable = true;

    	//Set up player
    	player = game.add.sprite(32, game.world.height - 100, 'player');
    	game.physics.arcade.enable(player);
    	player.body.gravity.y = 5000 * PLAYER_SCALE;
    	player.body.collideWorldBounds = true;
    	player.body.drag.set((3500 * PLAYER_SCALE), (2000 * PLAYER_SCALE));
    	player.body.maxVelocity.setTo((750 * PLAYER_SCALE), (2000 * PLAYER_SCALE));

    	//Set up bullets
	    bullets = game.add.group();
	    bullets.enableBody = true;
	    bullets.physicsBodyType = Phaser.Physics.ARCADE;
	    bullets.createMultiple(30, 'shot', 0, false);
	    bullets.setAll('anchor.x', 0.5);
	    bullets.setAll('anchor.y', 0.5);
	    bullets.setAll('outOfBoundsKill', true);
	    bullets.setAll('checkWorldBounds', true);

    	//Controls
    	button = game.input.keyboard.createCursorKeys();
	}

	function update(){
		game.physics.arcade.collide(player, platforms);

		//Horizontal movement
		if(button.left.isDown)
    	{
        	//Move to the left
        	if(player.body.velocity <= 0)
	        {
        		player.body.acceleration.x = -1000 * PLAYER_SCALE;
        	}
        	else
        	{
        		player.body.acceleration.x = -4500 * PLAYER_SCALE;
        	}
	    }
	    else if(button.right.isDown)
	    {
	        //Move to the right
	        if(player.body.velocity >= 0)
	        {
        		player.body.acceleration.x = 1000 * PLAYER_SCALE;
        	}
        	else
        	{
        		player.body.acceleration.x = 4500 * PLAYER_SCALE;
        	}
	    }
	    else
	    {
	        //Stop
        	player.body.acceleration.x = 0;
	    }

	    //Vertical movement
	    if(button.up.justPressed(250) && canJump == true)
	    {
	    	player.body.velocity.y = -1000 * PLAYER_SCALE;
	    	player.body.gravity.y = 500 * PLAYER_SCALE;
	    	canJump = false;
	    }

	    if(button.up.justReleased(250) || (!player.body.touching.down && player.body.velocity.y == 0))
	    {
	    	player.body.gravity.y = 5000 * PLAYER_SCALE;
	    }

	    if(player.body.touching.down && button.up.isUp)
		{
			canJump = true;
		}

		//Mouse click
		if (game.input.activePointer.isDown)
	    {
	        fire();
	    }
	}

	function fire () {

	    if (game.time.now > nextFire && bullets.countDead() > 0)
	    {
	        nextFire = game.time.now + fireRate;

	        var bullet = bullets.getFirstExists(false);

	        bullet.reset(player.x + player.body.halfWidth, player.y + player.body.halfHeight);

	        bullet.rotation = game.physics.arcade.moveToPointer(bullet, 1000, game.input.activePointer, 500);
	    }

	}

</script>
</body>
</html>